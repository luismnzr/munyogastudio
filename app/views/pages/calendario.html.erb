<div class="calendarioCover">
    <div class="calendarioCover__box">
      <h2>Calendario semanal</h2>
      <% if current_user %>
        <p style="margin: 10px 0;">Tus clases disponibles: <%= current_user.yogaclass %></p>
      <% end %>

      <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 20px; margin-top: 20px;">
        <%= link_to '← Semana Anterior', calendario_path(week: @current_week_offset - 1), class: 'button-white', style: 'display: inline-block; padding: 10px 20px; font-size: 14px;' %>
        <p style="margin: 0;">
          <%= l(@start_of_week, format: :short) %> - <%= l(@end_of_week, format: '%d de %b %Y') %>
        </p>
        <%= link_to 'Semana Siguiente →', calendario_path(week: @current_week_offset + 1), class: 'button-white', style: 'display: inline-block; padding: 10px 20px; font-size: 14px;' %>
      </div>

      <% if @current_week_offset != 0 %>
        <%= link_to 'Volver a semana actual', calendario_path, style: 'color: #111; font-size: 14px; margin-top: 10px; display: inline-block; text-decoration: underline;' %>
      <% end %>

    </div>
</div>
<div class="calendarGrid">
    <% 7.times do |i| %>
      <% date = @start_of_week + i.days %>
      <% day_sessions = @sessions_by_date[date] || [] %>
      <% is_today = date == @today %>

      <div class="calendarGrid-column">
        <h3 style="<%= 'color: #ee7756;' if is_today %>"><%= l(date, format: '%A') %></h3>
        <p style="font-size: 14px; color: <%= is_today ? '#ee7756' : '#666' %>; font-weight: <%= is_today ? 'bold' : 'normal' %>;">
          <%= date.strftime('%d/%m') %>
          <%= '(Hoy)' if is_today %>
        </p>

        <% if day_sessions.any? %>
          <% day_sessions.each do |session| %>
            <div class="calendarGrid-item" style="<%= 'opacity: 0.6;' if session.full? %>">
              <p><%= l(session.start_time, format: :time_only) %></p>
              <p class="calendarGrid-class"><%= session.class_type %></p>
              <% if session.instructor_name.present? %>
                <p style="font-size: 14px;"><%= session.instructor_name %></p>
              <% end %>

              <p style="font-size: 12px; margin: 10px 0; color: <%= session.available_spots > 0 ? '#111' : '#dc3545' %>;">
                <%= session.available_spots %> / <%= session.capacity %> espacios
              </p>

              <% if current_user %>
                <% is_past = session.datetime && session.datetime < Time.current %>
                <% user_reservation = current_user.reservations.confirmed.find_by(class_session_id: session.id) %>
                <% if is_past %>
                  <p style="background: #999; color: white; padding: 5px 10px; border-radius: 15px; font-size: 12px;">Finalizada</p>
                <% elsif user_reservation %>
                  <p class="button-white" style="padding: .5rem;">✓ Reservada</p>
                <% elsif session.full? %>
                  <p style="background: #dc3545; color: white; padding: 5px 10px; border-radius: 15px; font-size: 12px;">Lleno</p>
                <% elsif current_user.yogaclass > 0 %>
                  <%= button_to 'Reservar', reservations_path(class_session_id: session.id), method: :post, class: 'button-green' %>
                <% else %>
                  <p style="background: #ffc107; color: #000; padding: 5px 10px; border-radius: 15px; font-size: 12px;">Sin clases</p>
                <% end %>
              <% else %>
                <% is_past = session.datetime && session.datetime < Time.current %>
                <% if is_past %>
                  <p style="background: #999; color: white; padding: 5px 10px; border-radius: 15px; font-size: 12px;">Finalizada</p>
                <% else %>
                  <%= link_to 'Iniciar sesión', new_user_session_path, style: 'color: #007bff; font-size: 12px;' %>
                <% end %>
              <% end %>
            </div>
          <% end %>
        <% else %>
          <p style="color: #999; font-style: italic; padding: 20px 10px;">Sin clases</p>
        <% end %>
      </div>
    <% end %>
</div>
